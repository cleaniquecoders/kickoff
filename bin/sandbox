#!/usr/bin/env bash
# Sandbox helper for repeatedly testing `kickoff start` against the tracked `test-output/` directory
# without accidentally committing those changes. Designed for macOS (zsh/bash compatible).
#
# Commands:
#   run [<owner> <name>] Execute kickoff start into test-output/ (defaults: Demo Project)
#   reset               Delete test-output/ and restore it from Git HEAD (clean baseline)
#   allow-commit        Remove skip-worktree flag so updates to baseline CAN be committed
#   status              Show skip-worktree flag + diff status for test-output
#
# Typical cycle:
#   bin/sandbox run <owner> <project-name>
#   (inspect changes)
#   bin/sandbox reset
#
# To update the committed baseline (e.g. after legitimately changing stubs):
#   bin/sandbox allow-commit
#   (make changes / run kickoff)
#   git add test-output && git commit -m "Refresh test-output baseline"
#   bin/sandbox init
#
set -euo pipefail

TEST_DIR="test-output"

cmd_run() {
  local owner="${1:-Demo}"; [ $# -gt 0 ] && shift || true
  local name="${1:-Project}"; [ $# -gt 0 ] && shift || true
  # Mark skip-worktree to keep changes local only
  git update-index --skip-worktree "$TEST_DIR" || true
  echo "Running kickoff with owner='$owner' name='$name' into '$TEST_DIR/'" >&2
  php bin/kickoff start "$owner" "$name" "$TEST_DIR/"
}

cmd_reset() {
  echo "Deleting $TEST_DIR ..."
  rm -rf "$TEST_DIR"
  echo "Restoring $TEST_DIR from Git HEAD..."
  # Fully restore both index and working tree from HEAD using git restore
  git restore --source=HEAD --staged --worktree -- "$TEST_DIR" || {
    echo "Failed to restore from git. Does $TEST_DIR exist in the repository?" >&2
    exit 1
  }
  # Ensure local skip-worktree is kept so subsequent runs don't show diffs
  git update-index --skip-worktree "$TEST_DIR" || true
  echo "Reset complete."
}

main() {
  local cmd="${1:-}"; shift || true
  case "$cmd" in
    run) cmd_run "$@" ;;
    reset) cmd_reset ;;
    *) echo "Usage: $0 {run|reset} (run accepts optional <owner> <name>, defaults: Demo Project)" >&2; exit 1 ;;
  esac
}

main "$@"
