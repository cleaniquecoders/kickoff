#!/usr/bin/env bash
# Sandbox helper for repeatedly testing `kickoff start` against the tracked `test-output/` directory
# without accidentally committing those changes. Designed for macOS (zsh/bash compatible).
#
# Commands:
#   run [<owner> <name>] Execute kickoff start into test-output/ (defaults: Demo Project)
#   reset               Delete test-output/ and restore it from Git HEAD (clean baseline)
#   allow-commit        Remove skip-worktree flag so updates to baseline CAN be committed
#   status              Show skip-worktree flag + diff status for test-output
#
# Typical cycle:
#   bin/sandbox run <owner> <project-name>
#   (inspect changes)
#   bin/sandbox reset
#
# To update the committed baseline (e.g. after legitimately changing stubs):
#   bin/sandbox allow-commit
#   (make changes / run kickoff)
#   git add test-output && git commit -m "Refresh test-output baseline"
#   bin/sandbox init
#
set -euo pipefail

# Minimal sandbox helper for creating/removing a Laravel sandbox inside test-output/

SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
TEST_DIR="$REPO_ROOT/test-output"
SANDBOX_DIR="$TEST_DIR/sandbox"

need_installer() {
  command -v laravel >/dev/null 2>&1 || {
    echo "Missing 'laravel' installer. Install with: composer global require laravel/installer" >&2
    exit 127
  }
}

git_mark_skip() { git -C "$(cd -- "$SCRIPT_DIR/.." && pwd)" update-index --skip-worktree test-output 2>/dev/null || true; }

need_kickoff() {
  [ -f "$REPO_ROOT/bin/kickoff" ] || {
    echo "Missing kickoff binary at $REPO_ROOT/bin/kickoff" >&2
    exit 2
  }
}

run() {
  need_installer
  need_kickoff
  git_mark_skip
  mkdir -p "$TEST_DIR"
  if [ -d "$SANDBOX_DIR" ]; then
    echo "Removing existing sandbox ..." >&2
    rm -rf "$SANDBOX_DIR"
  fi
  echo "Creating Laravel sandbox ..." >&2
  (cd "$TEST_DIR" && laravel new sandbox --git --livewire --pest --npm --livewire-class-components --no-interaction)
  echo "Sandbox scaffolded: $SANDBOX_DIR" >&2

  # Run kickoff against the freshly created sandbox (use sandbox identifiers)
  echo "Running kickoff start for sandbox/sandbox ..." >&2
  php "$REPO_ROOT/bin/kickoff" start sandbox sandbox "$SANDBOX_DIR"

  # Seed dummy notifications for the superadmin user
  echo "Seeding dummy notifications for superadmin ..." >&2
  (cd "$SANDBOX_DIR" && php artisan db:seed --class=NotificationSeeder)

  echo "Sandbox ready with kickoff applied: $SANDBOX_DIR" >&2
}

reset() {
  if [ -d "$SANDBOX_DIR" ]; then
    echo "Deleting $SANDBOX_DIR" >&2
    rm -rf "$SANDBOX_DIR"
  else
    echo "No sandbox directory to delete." >&2
  fi
}

case "${1:-}" in
  run) shift; run ;;
  reset) shift; reset ;;
  *) echo "Usage: $0 {run|reset}\n  run                 Create Laravel app then run kickoff start (owner/name: sandbox)\n  reset               Delete test-output/sandbox" >&2; exit 1 ;;
esac
